const express = require('express'); const router = express.Router(); const Transaction = require('../models/Transaction'); const Project = require('../models/Project'); router.post('/deposit', async (req,res)=>{ const { projectId, fromUserId, amount } = req.body; const tx = await Transaction.create({ tx_ref: require('uuid').v4(), from_user: fromUserId, amount, status:'pending', meta:{projectId} }); const project = await Project.findById(projectId); if(project){ project.escrow_amount = (project.escrow_amount||0)+amount; await project.save(); } res.json({ success:true, tx }); }); router.post('/release', async (req,res)=>{ const { projectId, toUserId, amount } = req.body; const project = await Project.findById(projectId); if(!project) return res.status(404).json({ error:'Not found' }); if((project.escrow_amount||0) < amount) return res.status(400).json({ error:'Insufficient escrow' }); project.escrow_amount -= amount; await project.save(); const tx = await Transaction.create({ tx_ref: require('uuid').v4(), to_user: toUserId, amount, status:'completed', meta:{projectId} }); res.json({ success:true, tx }); }); module.exports = router;
